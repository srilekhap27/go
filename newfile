package handler

import (
	"context"
	"encoding/json"
	"errors"
	"net/http"
	"testing"
	"time"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-sdk-go-v2/service/dynamodb"
	"github.com/aws/aws-sdk-go-v2/service/dynamodb/types"
	"github.com/stretchr/testify/assert"
	"prodgitlab.usaa.com/grp-aws-my-documents/mydocs-cloud-commons/modules/models"
	"prodgitlab.usaa.com/grp-aws-my-documents/mydocs-cloud-commons/modules/repositories"
)

type MockDynamoDB struct {
	repositories.DbClientInterface
	QueryFunc func(ctx context.Context, params *dynamodb.QueryInput, optFns ...func(*dynamodb.Options)) (*dynamodb.QueryOutput, error)
}

func (m *MockDynamoDB) Query(ctx context.Context, params *dynamodb.QueryInput, optFns ...func(*dynamodb.Options)) (*dynamodb.QueryOutput, error) {
	return m.QueryFunc(ctx, params, optFns...)
}

func TestGetHandler(t *testing.T) {
	tests := []struct {
		name               string
		request            events.APIGatewayProxyRequest
		dynamoDBMock       func() repositories.Connection
		expectedStatusCode int
		expectedBody       func() string
	}{
		{
			name: "Valid Batch ID",
			request: events.APIGatewayProxyRequest{
				PathParameters: map[string]string{
					"bulkBatchId": "valid-batch",
				},
			},
			dynamoDBMock: func() repositories.Connection {
				return repositories.Connection{
					DbClient: &MockDynamoDB{
						QueryFunc: func(ctx context.Context, params *dynamodb.QueryInput, optFns ...func(*dynamodb.Options)) (*dynamodb.QueryOutput, error) {
						return &dynamodb.QueryOutput{
							Items: []map[string]types.AttributeValue{
								{"PartitionKey": &types.AttributeValueMemberS{Value: "PARTY#123"}, "SortKey": &types.AttributeValueMemberS{Value: "DOC#guid1#DISP_DT#2024-01-01"}, "BulkBatchID": &types.AttributeValueMemberS{Value: "valid-batch"}},
							},
						}, nil
					},
				},
			}
		},
			expectedStatusCode: http.StatusOK,
			expectedBody: func() string {
				body, _ := json.Marshal([]ResponseBody{{
					PartitionKey: "123",
					DocumentGUID: "guid1",
					DisplayDate:  "2024-01-01",
					BulkBatchID:  "valid-batch",
				}})
				return string(body)
			},
		},
		{
			name: "No Documents Found",
			request: events.APIGatewayProxyRequest{
				PathParameters: map[string]string{
					"bulkBatchId": "empty-batch",
				},
			},
			dynamoDBMock: func() repositories.Connection {
				return repositories.Connection{
					DbClient: &MockDynamoDB{
						QueryFunc: func(ctx context.Context, params *dynamodb.QueryInput, optFns ...func(*dynamodb.Options)) (*dynamodb.QueryOutput, error) {
							return &dynamodb.QueryOutput{}, nil
						},
					},
				}
			},
			expectedStatusCode: http.StatusNotFound,
			expectedBody: func() string {
				body, _ := json.Marshal(OutputResponse{
					BatchID:      "empty-batch",
					ErrorMessage: "No Documents found with given BatchID",
					Timestamp:    time.Now(),
				})
				return string(body)
			},
		},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			h := &Handler{DynamoDB: tt.dynamoDBMock()}
			response, err := h.GetHandler(tt.request)
			assert.NoError(t, err)
			assert.Equal(t, tt.expectedStatusCode, response.StatusCode)

			var expectedOutput, actualOutput OutputResponse
			_ = json.Unmarshal([]byte(tt.expectedBody()), &expectedOutput)
			_ = json.Unmarshal([]byte(response.Body), &actualOutput)
			expectedOutput.Timestamp = actualOutput.Timestamp
			assert.Equal(t, expectedOutput, actualOutput)
		})
	}
}
