import React from 'react';
import { Provider } from 'react-redux';
import DocumentList from '../../../src/components/DocumentList';
import { render, fireEvent, waitFor } from '@testing-library/react';
import { documents } from '../../../src/api/dev/testData';
import { configureStore } from '@reduxjs/toolkit';
import rootReducer from '../../../src/redux/documentSlice';
import { ERROR_MESSAGES, handleErrorAndLog, Severity } from '../../../src/utils/logger';

var mockDispatch = jest.fn();

jest.mock('../../../src/hooks/APIHook.js');
jest.mock('../../../src/api/Api', () => ({
    retrieveDocument: jest.fn(),
}));

import { retrieveDocument } from '../../../src/api/Api';

jest.mock('../../../src/utils/logger', () => ({
    ...jest.requireActual('../../../src/utils/logger'),
    handleErrorAndLog: jest.fn(),
}));

const action = {
    documentList: [documents, 200],
    filters: [],
    sorts: [],
    errors: [],
    resultCount: null,
    isMobile: false,
    documentError: '',
    loader: false,
    empty: false,
};

const createStore = (initialState = action) => {
    return configureStore({
        reducer: rootReducer,
        preloadedState: { action: initialState },
    });
};

describe('DocumentList component - Web View', () => {
    let store;

    beforeEach(() => {
        process.env.USAA_PLATFORM = 'standard';
        process.env.USAA_ENV = 'development';
        store = createStore();
        jest.clearAllMocks();
    });

    it('should log an error when response is undefined', async () => {
        retrieveDocument.mockResolvedValue(undefined);

        const { getByTestId } = render(
            <Provider store={store}>
                <DocumentList />
            </Provider>
        );

        fireEvent.click(getByTestId('readDoc-0'));

        await waitFor(() => {
            expect(handleErrorAndLog).toHaveBeenCalledWith(
                null,
                expect.any(String), // affectedFunction
                'Failed to retrieve document contents',
                'Response array returned by retrieveDocument function is undefined',
                Severity.ERROR
            );
        });
    });

    it('should log an error when response array length is less than 2', async () => {
        retrieveDocument.mockResolvedValue([{}]); // Array with only one item

        const { getByTestId } = render(
            <Provider store={store}>
                <DocumentList />
            </Provider>
        );

        fireEvent.click(getByTestId('readDoc-0'));

        await waitFor(() => {
            expect(handleErrorAndLog).toHaveBeenCalledWith(
                null,
                expect.any(String), // affectedFunction
                'Failed to retrieve document contents',
                'Size of Response array returned by retrieveDocument function is 1. Minimum size of 2 is expected.',
                Severity.ERROR
            );
        });
    });

    it('should handle exception when retrieveDocument throws an error', async () => {
        retrieveDocument.mockImplementation(() => {
            throw new Error('Mocked fetch error');
        });

        const { getByTestId } = render(
            <Provider store={store}>
                <DocumentList />
            </Provider>
        );

        fireEvent.click(getByTestId('readDoc-0'));

        await waitFor(() => {
            expect(handleErrorAndLog).toHaveBeenCalledWith(
                expect.any(Error),
                expect.any(String), // affectedFunction
                'Failed to retrieve document contents to view',
                '',
                Severity.ERROR
            );
        });
    });
});
